function create_vue_app(t){var e=t.category_list,a=t.categories;return e[0]&&a[e[0].href],new Vue({el:"#app",data:{current_category:{},category_url:"",tags:{},pages:{},current_page:{},current_category_name:"",base_url:"view/",category_list:e,categories:a,page_content_view:"page-content-grid",error_message:{},page_content:{},main_page_view:"page-content-grid",features:{}},methods:{show_error:function(t){this.error_message.message=t,this.page_content_view="error-message",this.page_content=this.error_message,this.current_category={}},restore_page_view:function(){this.page_content_view!==this.main_page_view&&(this.page_content_view=this.main_page_view)},show_update_form:function(t,e,a,i){this.show_category(e),this.page_content_view="form-update",this.page_content={item:t,callback:a,tags:this.tags,cancel_callback:i}},check_error:function(){this.error_message.message&&(this.error_message.message="",this.page_content_view="page-content-grid")},select_category:function(t){this.current_category_name=t,this.current_category=this.categories[t],this.tags=this.current_category.tags,this.category_url=this.base_url+t+"/",this.active_page_name="",this.features=this.current_category.favorites},show_category:function(t){this.categories[t]&&t!==this.current_category_name&&this.select_category(t)},show_page:function(t){this.current_category_name&&(this.active_page_name===t&&this.page_content_view===this.main_page_view||(this.main_page_view=this.page_content_view="page-content-grid",this.restore_page_view(),this.active_page_name=t,this.current_page=this.categories[this.current_category_name].pages[t],this.page_content={data:this.current_page,category:this.current_category_name}))},show_search_result:function(t){this.change_page_view("page-table-view"),this.page_content_view="page-table-view",this.page_content={results:t}},change_page_view:function(t){this.main_page_view=t,this.show_page(this.active_page_name)}}})}function Application(t){this.database=t,this.get_database_name(),dynalinks=this.dynalinks=new Dynalinks(this.database);var e=this;document.addEventListener("DOMContentLoaded",function(t){e.initialize()&&e.initialize()})}function Dynalinks(t,e){this.database=t.database,this.names=t.names,this.features=t.features,this.categories={},e||this.parse_database()}function check_key(t,e){for(var a in t)if(a===e)return!0;return!1}function PopupForm(t){this.dict=t.dict,this.selected=t.selected,this.type=t.type,this.template=t.template,this.handler=t.handler,this.change_text=t.change_text,this.title=t.title,this.not_escape=t.not_escape,this.text="",this.result=-1;var e=!0;this.initialize=function(){if(e){Form_Fabric.not_escape=!!t.not_escape,t.form?this.form=t.form:t.fields?this.form=Form_Fabric.create_fields(t.fields):this.form=Form_Fabric.create(t.type,t.value,t.dict),this.create_template(t);var a=this.template.querySelector(".mt-input-container");a?a.innerHTML="":((a=document.createElement("div")).className="mt-input-container",console.log("not found mt-input-container, need create it"),this.template.appendChild(a)),a.appendChild(this.form);var i=this;(a=this.template.querySelector(".edit-form-ok-btn")).onclick=function(t){i._ok()},(a=this.template.querySelector(".edit-form-cancel-btn")).onclick=function(t){i.cancel()},this.init(),e=!1}}}function ModalForm(){PopupForm.apply(this,arguments)}function register_main_menu(t){var e={data:function(){return{search_text:""}},template:'<div class="top-line top-buttons line-menu">\t<ul>\t<li><a href="javascript:void(0);" id="button-add" v-on:click="add_item">Добавить ссылку</a></li>\t<li><a href="javascript:void(0);" id="button-create-category" v-on:click="create_category">Создать категорию</a></li>\t<li><a href="javascript:void(0);" id="button-move" v-on:click="move_page">Перенести</a></li>\t<li><a href="javascript:void(0);"> Удалить</a>\t\t<ul>\t\t\t<li><a href="javascript:void(0);" id="button-remove-tag" v-on:click="remove_page"> страницу</a></li>\t\t\t<li><a href="javascript:void(0);" id="button-remove-category" v-on:click="remove_category"> категорию</a></li>\t\t</ul>\t</li>\t<li><A href="javascript:void(0);">Экспортировать</a>\t\t<ul>\t\t<li><a href="javascript:void(0);" id="button-export-tag" v-on:click="export_page"> страницу</a></li>\t\t<li><a href="javascript:void(0);" id="button-export-category" v-on:click="export_category"> категорию </a>\t</li>\t\t</ul>\t</li>\t\x3c!--li><a href="javascript:void(0);" id="button-edit-page" v-on:click="edit_mode">Правка</a></li--\x3e\t<li><a href="javascript:void(0);" id="button-save" v-on:click="save_all"> Сохранить всё</a></li>\t<li><input type="text" id="search-box" v-model="search_text" placeholder="искать..."><button type="button" id="search-button" v-on:click="search_record">искать</button></li>\t</ul></div>',methods:{save_all:function(){t.save_to_file()},add_item:function(){t.add_item()},create_category:function(){t.create_category()},remove_page:function(){t.remove_tag()},remove_category:function(){t.remove_category()},move_page:function(){t.move_tag()},export_category:function(){t.export_category()},export_page:function(){t.export_tag()},search_record:function(){t.search(this.search_text)}}};new Vue({el:"#main-menu-app",components:{"application-main-menu":e}})}function My_Router(){this.routes=new Array}function Vue_Application(t){Application.call(this,t),this.dynalinks.Database_Var="my_links"}function find_database(){var t;return"object"==typeof window?t=window:"object"==typeof global&&(t=global),t&&t.my_links?t.my_links:(console.log("Error! database is undefined! Created empty database!"),{database:{},names:{}})}function get_first_key(t){for(var e in t)if(t.hasOwnProperty(e))return e}function get_first_key_secure(t){for(var e in t)if(t.hasOwnProperty(e)&&void 0!==t[e])return e}function find_all_by_field_value(t,e,a){for(var i=new Array,n=0;n<t.length;n++)a===t[n][e]&&i.push(t[n]);return i}function remove_by_value(t,e){for(var a=0;a<t.length;)t[a]===e?t.splice(a,1):a++}function find_by_field_value(t,e,a){for(var i=0;i<t.length;i++)if(a===t[i][e])return t[i];return null}function find_index_by_field_value(t,e,a){for(var i=0;i<t.length;i++)if(a===t[i][e])return i;return-1}function remove_by_field_value(t,e,a){for(var i=0;i<t.length;i++)if(a===t[i][e]){var n=t[i];return t.splice(i,1),n}return null}function remove_all_by_field_value(t,e,a){for(var i=0;i<t.length;)a===t[i][e]?t.splice(i,1):i++;return null}function dictionary_to_array(t,e,a){e||(e="key"),a||(a="value");var i=new Array,n={};for(var o in t)t.hasOwnProperty(o)&&((n={})[e]=o,n[a]=t[o],i.push(n));return i}function create_url(){for(var t="",e=0;e<arguments.length;e++)void 0!==arguments[e]&&(e>0&&(t+="/"),t+=encodeURIComponent(arguments[e]));return t}function copy_object(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}function create_clone_object(t){var e={};return copy_object(e,t),e}function clone_fields(t,e){for(var a={},i=0;i<e.length;i++){var n=e[i];a[n]=t[n]}return a}function every_property(t,e){if(e)for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&e(a);else console.log("callback given every_property is undefined or null!")}function every_index(t,e){if(e)for(var a=0;a<t.length;a++)e(a)}Vue.component("page-item",{props:["link_item"],template:'<a v-bind:href="link_item.href"> {{link_item.text}} </a>'}),Vue.component("page-content-grid",{props:["page_content"],template:'<div class="tab-content" id="page-content">\t<div class="control-panel">\t\t<a href="javascript:void(0);" class="edit-button link-button" v-on:click="turn_edit">Правка</button>\t</div>    <div class="data-grid">\t<div class="editable-link" v-for="item in page_content.data">\t\t<div class="button-panel" v-if="edit_mode">\t\t\t<a class="edit-btn" v-bind:href="\'#update/\'+page_content.category + \'/\'+item._id" v-bind:key="item._id">\tПравка\t</a>\t\t\t<button type="button" class="delete-btn"  v-on:click="delete_record(item._id)" v-bind:key="item._id"> Удалить </button>\t\t</div>\t\t<a v-bind:href="item.href" v-bind:key="item._id"> {{item.text}}</a>\t</div>    </div></div>',data:function(){return{edit_mode:!1}},methods:{turn_edit:function(t){this.edit_mode=!this.edit_mode},delete_record:function(t){event_bus.$emit("delete-record",t)}}}),Vue.component("page-content-text",{props:["page_content"],template:'<div id="page-content"> <p v-for="item in page_content"> <page-item v-bind:link_item="item" v-bind:key="item._id"> </page-item></p> </div>'}),Vue.component("dynamic-link",{props:["base_url","url","fragments","text","params"],render:function(t){var e=this.params&&this.params.href||this.url,a="";return a=this.fragments&&this.fragments.length>0?this.fragments.join("/"):e,this.base_url&&(a=this.base_url+"/"+a),t("a",{attrs:{href:a}},this.params&&this.params.text||this.url||this.text||a)}}),Vue.component("page-table-view",{props:["page_content"],template:'<div><p>результаты поиска</p>\t\t<h3>Найдено <span> {{page_content.results.length}} </span> записей </h3>\t\t<table class="search-result">\t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<td>Ссылка</td>\t\t\t\t\t<td>Страница</td>\t\t\t\t\t<td>Категория</td>\t\t\t\t\t<td>Показать на странице</td>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody >\t\t\t\t<tr v-for="item in page_content.results">\t\t\t\t\t<td><a v-bind:href="item.item.href"> {{item.item.text}} </a></td>\t\t\t\t\t<td >{{item.item.text}}</td>\t\t\t\t\t<td >{{item.category}}</td>\t\t\t\t\t<td> <dynamic-link v-bind:fragments="[item.category,item.item.tag]" v-bind:text="item.item.text" v-bind:base_url="\'#view\'"></dynamic-link> </td>\t\t\t\t</tr>\t\t\t</tbody>\t\t</table>\t</div>'}),Vue.component("error-message",{props:["page_content"],template:'<div id="message-block" class="error-message"><h1>Error</h1> <p>{{page_content.message}}</p></div>'});var event_bus=new Vue;Vue.component("routed-link",{props:["base_url","url"],render:function(t){var e="#"+this.base_url,a=this.url.text||this.url;return this.url.href?e+=this.url.href:e+=this.url,t("a",{attrs:{href:e}},a)}}),Vue.component("category-menu",{props:["category_list","base_url"],template:'<div class="top-line top-buttons">\t\t<routed-link v-for="item in category_list" v-bind:url="item" v-bind:base_url="base_url"> </routed-link>\t\t</div>'}),Vue.component("dropdown-category-menu",{props:["category_list","base_url","categories"],template:'<div class="line-menu">        <ul class="top-line top-buttons">        <li v-for="item in category_list">            <routed-link  v-bind:url="item" v-bind:base_url="base_url"> </routed-link>            <ul v-if="categories[item.href]" class="submenu">                <li v-for="link in categories[item.href].favorites">                    <a :href="link.href">{{link.favorite_text || link.text}}</a>                </li>            </ul>        </li>\t\t</ul></div>'}),Vue.component("features-line",{props:["features"],template:'<div ><div class="features-line" id="favorites-menu">\t<a class="features-button" v-for="item in features" v-bind:href="item.href">{{item.favorite_text}}</a></div></div>'}),Vue.component("page-menu",{props:["base_url","tags"],template:'<div class="buttons-headers" id="page-menu"> <routed-link v-for="item in tags" v-bind:url="item" v-bind:base_url="base_url"> </routed-link> </div>'}),Vue.component("form-update",{props:["page_content"],methods:{cancel:function(){this.page_content.cancel_callback?this.page_content.cancel_callback():console.log("Error cancel add new record! Not given cancel callback!")},save:function(){this.message&&(this.message=""),(this.page_content.item.tag||this.new_tag)&&this.page_content.item.href&&this.page_content.item.text?(this.page_content.item.tag=this.new_tag||this.page_content.item.tag,this.page_content.callback&&this.page_content.callback(this.page_content.item)):this.message="Одно или несколько обязательных полей не заполнены!"},is_favorite:function(){return!!this.page_content.item.favorite},change_favorite:function(){this.my_features=this.page_content.item.favorite=!this.page_content.item.favorite,this.my_features&&!this.page_content.item.favorite_text&&(this.page_content.item.favorite_text=this.page_content.item.text)}},activated:function(){this.my_features=this.is_favorite()},data:function(){var t={};return t.message="",t.new_tag=void 0,t.my_features=!1,t.page_content={},t},template:'\t<div class="update-form" id="update-form">\t<h3>Создание новой записи</h3>\t<div v-if="message" class="warning-message">{{message}}</div>\t<div class="required-fields fields"> <h3>Обязательно заполните эти поля</h3>\tАдрес <br><input type="text" v-model="page_content.item.href" size=60>\t<p> Текст <br> <input type="text" v-model="page_content.item.text" size=60>\t<p> Выберите тег <select class="select-tag" v-model="page_content.item.tag"> <option v-for="tag in page_content.tags" v-bind:value="tag"> {{tag}} </otion> </select>\tили создайте новый <input type="text" v-model="new_tag">\t</div>\t<div class="other-fields fields">\t<p>Избранное <button type="button" v-on:click="change_favorite">{{is_favorite()?"Remove":"Add"}}</button>\tТекст для избранного <input v-model="page_content.item.favorite_text" v-bind:disabled="!my_features">\t</div>\t<button class="save-button" type="button" v-on:click="save" id="update-form-save-button">Save</button>\t<button class="cancel-button" type="button" v-on:click="cancel">Отмена</button>\t</div>'});var mr;Application.prototype.remove_item=function(t){var e=this;new PopupForm({type:"label",value:"Правда удалить?",handler:function(a){e.dynalinks.remove_by_id(t)}}).show()},Application.prototype.move_tag=function(){var t={};t.title="Перенести страницу в другую категорию",t.type="custom",t.dict=dynalinks.names,t.fields=[{type:"select",dict:dynalinks.names,"data-value":"category"},{type:"text","data-value":"new_category"}];var e=this;t.handler=function(t){var a=e.dynalinks.context.current_tag,i=e.dynalinks.context.category_name,n=t.new_category||t.category;e.dynalinks.move_tag(a,i,n),mr.navigate(e.dynalinks.create_url(n,a),!0)},new PopupForm(t).show()},Application.prototype.add_item=function(){var t={};t.type="custom";var e=document.createElement("div"),a={};a.tags=this.dynalinks.context.tags,a.value=[this.dynalinks.context.current_tag],ko.renderTemplate("create-item-template",a,{},e),t.form=e;var i=this;t.handler=function(t){t.new_tag&&(t.tag=t.new_tag,delete t.new_tag);var e=i.dynalinks.context.category_name,a=t.tag;i.dynalinks.add_link_to_category(t,e),mr.navigate(i.dynalinks.create_url(e,a),!0)},new PopupForm(t).show()},Application.prototype.edit_item=function(t){var e=this.dynalinks.get_from_active_context(t),a={type:"custom"},i=document.createElement("div"),n={};n.tags=this.dynalinks.context.tags,n.item=e,ko.renderTemplate("edit-item-template",n,{},i),a.form=i;var o=this;a.handler=function(t){var a=o.dynalinks.update_item(e,t);mr.navigate(o.dynalinks.create_url(a.category,a.tag),!0)},new PopupForm(a).show()},Application.prototype.turn_edit=function(){"page_view"===this.dynalinks.display.mode?this.dynalinks.display.mode="page_edit":this.dynalinks.display.mode="page_view",this.dynalinks.show_page(this.dynalinks.context.current_tag)},Application.prototype.export_category=function(){this.dynalinks.export_category(this.dynalinks.context.category_name)},Application.prototype.export_tag=function(){this.dynalinks.export_tag(this.dynalinks.context.category_name,this.dynalinks.context.current_tag)},Application.prototype.remove_category=function(){var t={type:"label",value:"Правда удалить эту категорию?"},e=this;t.handler=function(t){e.dynalinks.remove_category(e.dynalinks.context.category_name),mr.navigate(e.dynalinks.create_url(get_first_key(e.dynalinks.names)),!0)},new PopupForm(t).show()},Application.prototype.remove_tag=function(){var t={type:"label",value:"Правда удалить эту страницу?"},e=this;t.handler=function(t){e.dynalinks.remove_tag(e.dynalinks.context.category_name,e.dynalinks.context.current_tag),mr.navigate(e.dynalinks.create_url(e.dynalinks.context.category_name),!0)},new PopupForm(t).show()},Application.prototype.create_category=function(){var t={};t.type="text",t.title="Название новой папки";var e=this;t.handler=function(t){e.dynalinks.add_category(t),mr.navigate(e.dynalinks.create_url(t),!0)},new PopupForm(t).show()},Application.prototype.move_item=function(){},Application.prototype.search=function(t){var e=t.trim();e&&mr.navigate(create_url("search",e),!0)},Application.prototype.show_search_results=function(t){var e={results:this.dynalinks.search(["text","href"],t)},a=document.getElementById("page-content");ko.cleanNode(a),a.innerHTML="",ko.renderTemplate("template-search-result",e,{},a)},Application.prototype.init_router=function(){(mr=new My_Router).add_route("view/:category/:page",function(t,e){this.current_category&&this.current_category===t?this.show_page(e):(this.show_category(t),this.show_page(e))},this.dynalinks),mr.add_route("view/:category",function(t){this.show_category(t),this.show_page(null)},this.dynalinks),mr.add_default(function(){this.show_category(null),this.show_page(null)},this.dynalinks),mr.add_route("search/:value",function(t){this.show_search_results(decodeURIComponent(t))},this),mr.start(!0)};var dynalinks;Application.prototype.get_database_name=function(){var t=window.location.href.split("#")[0].split("/");t=t[t.length-1].split("."),this.Save_Filename=t[0]+".txt"},Application.prototype.save_to_file=function(t){this.dynalinks.save_to_file(t||this.Save_Filename)},Application.prototype.initialize=function(){this.init_router(),this._child_init&&this._child_init()},Dynalinks.Utils={},Dynalinks.Utils.create_id=function(){return Math.random().toString(36).substr(2,9)+Date.now().toString()},Dynalinks.Utils.check_item=function(t){t._id||(t._id=Dynalinks.Utils.create_id()),t.favorite&&!t.favorite_text&&(t.favorite_text=t.text),!t.favorite&&t.favorite_text&&(t.favorite=!0)},Dynalinks.Utils.check_database=function(t){for(var e in t){arr=t[e];for(var a=0;a<arr.length;a++)Dynalinks.Utils.check_item(arr[a])}},Dynalinks.Utils.create_features_first=function(t){var e={};return every_property(t.categories,function(a){var i=t.categories[a].favorites;i.length>0&&(e[a]=[],every_index(i,function(t){e[a].push({_id:i[t]._id,text:i[t].favorite_text})}))}),e},Dynalinks.prototype.create_url=function(t,e){var a=Array.prototype.slice.call(arguments,0);return a.unshift("view"),create_url.apply(this,a)},Dynalinks.Features=function(t){this.features=t,this.build_hash()},Dynalinks.Features.prototype.build_hash=function(){this.hash={};var t=this;every_property(this.features,function(e){var a=t.features[e];every_index(a,function(i){var n=a[i];t.hash[n._id]=e})})},Dynalinks.Features.prototype.remove_feature=function(t){var e=this.hash[t];e&&remove_by_field_value(this.features[e],"_id",t),delete this.hash[t]},Dynalinks.Features.prototype.add_feature=function(t,e,a){this.hash[t]=e,this.features[e]||(this.features[e]=[]),this.features[e].push({_id:_id,text:a})},Dynalinks.prototype.Database_Name="database.txt",Dynalinks.Context=function(t,e){if(this.category_name=e,this.pages={},this.favorites=new Array,this.tags=new Array,this.hash={},t)for(var a,i,n=0;n<t.length;n++)a=t[n],this.hash[a._id]=a,i=a.tag,this.pages[i]||(this.pages[i]=new Array,this.tags.push(i)),this.pages[i].push(a),a.favorite&&this.favorites.push(a)},Dynalinks.Context.prototype.move_item=function(t,e){var a=this.get_page(t.tag);this.get_page(e).push(t),t.tag=e,remove_by_field_value(a,"_id",t._id)},Dynalinks.Context.prototype.check_favorite=function(t,e){var a=find_index_by_field_value(this.favorites,"_id",t._id);a<0?t.favorite&&this.favorites.push(t):t.favorite||this.favorites.splice(a,1)},Dynalinks.Context.prototype.change_favorite=function(t,e,a){if(t.favorite!==e||t.favorite_text!==a){var i=function(t,e,a){i="";if(e){var i=a||t.favorite_text||t.text;a&&a!==i&&(i=a)}return i}(t,e,a);t.favorite!==e&&(t.favorite=e,t.favorite?(t.favorite_text=i,this.favorites.push(t)):(remove_by_field_value(this.favorites,"_id",t._id),delete t.favorite_text),!1)}},Dynalinks.Context.prototype.get_page=function(t){var e=this.pages[t];return e||(this.pages[t]=e=new Array,this.tags.push(t)),e},Dynalinks.Context.prototype.remove_page=function(t){var e=this.pages[t];if(delete this.pages[t],e){for(var a=0;a<e.length;a++)delete this.hash[e._id];remove_by_value(this.tags,t),remove_by_field_value(this.favorites,"tag",t)}},Dynalinks.Context.prototype.add_item=function(t){Dynalinks.Utils.check_item(t),this.hash[t._id]||(this.get_page(t.tag).push(t),t.favorite&&this.favorites.push(t),this.hash[t._id]=t)},Dynalinks.Context.prototype.remove_item=function(t){this.hash[t._id]&&(t.favorite&&remove_by_field_value(this.favorites,"_id",t._id),remove_by_field_value(this.get_page(t.tag),"_id",t._id),delete this.hash[t._id])},Dynalinks.prototype.create_context=function(t){var e=this.database[t];return e?new Dynalinks.Context(e,t):(console.log("error create context! Not found category ",t),null)},Dynalinks.prototype.get_category_context=function(t,e){var a=this.categories[t];return a&&!e||(this.categories[t]=a=this.create_context(t)),a},Dynalinks.prototype.get_active_context=function(){return this.get_category_context(this.current_category)},Dynalinks.prototype.get_page_template=function(){return this.templates[this.display_mode]},Dynalinks.prototype.get_first_page_from_category=function(t){return this.get_category_context(t).tags[0]},Dynalinks.prototype.get_page_from_category=function(t,e){return this.get_category_context(t).pages[e]},Dynalinks.prototype.set_category=function(t){var e=this.get_category_context(t);this.context=e,this.current_category=t},Dynalinks.prototype.set_page=function(t){if(this.context=this.get_active_context(),this.context){if(!t||!this.context.pages[t]){(t=get_first_key_secure(this.context.pages))||console.log("category is empty, there are not page for show they")}this.context.current_tag=t,this.current_page=this.context.pages[t]}},Dynalinks.prototype.parse_database=function(){for(var t in this.names)Object.prototype.hasOwnProperty.call(this.names,t)&&this.get_category_context(t);this.category_list=dictionary_to_array(this.names,"href","text"),this.category_list.length>0&&(t=this.category_list[0].href,this.set_category(t))},Dynalinks.prototype.add_link_to_category=function(t,e){this.database[e]||console.log("Error! This category doesn't exits!",e),this.database[e].push(t),this.get_category_context(e).add_item(t)},Dynalinks.prototype.remove_by_id=function(t){var e=remove_by_field_value(this.database[this.context.category_name],"_id",t);this.context.remove_item(e)},Dynalinks.prototype.add_category=function(t){this.database[t]?alert("��������� � ����� ��������� ��� ����������!"):t?(this.database[t]=new Array,this.names[t]=t,this.get_category_context(t),this.category_list.push({href:t,text:t})):alert("��� ����� ��������� �� ������!")},Dynalinks.prototype.remove_tag=function(t,e){remove_all_by_field_value(this.database[t],"tag",e),this.get_category_context(t).remove_page(e)},Dynalinks.prototype.move_tag=function(t,e,a){if(e!==a){this.names[a]||this.add_category(a);for(var i=this.database[e],n=this.database[a],o=0;o<i.length;)i[o].tag===t?(n.push(i[o]),i.splice(o,1)):o++;this.get_category_context(e,!0),this.get_category_context(a,!0)}},Dynalinks.prototype.save_data_to_file=function(t,e,a){var i=JSON.stringify(e,null," ");i="var "+a+" = "+i+";\n";var n=new Blob([i],{type:"text/plain;charset=utf-8"});saveAs(n,t)},Dynalinks.prototype.save_to_file=function(t,e){var a={database:this.database,names:this.names,features:this.features};this.save_data_to_file(t||this.Database_Name,a,this.Database_Var)},Dynalinks.prototype.get_from_active_context=function(t){return find_by_field_value(this.database[this.context.category_name],"_id",t)},Dynalinks.prototype.update_item=function(t,e){t.favorite=!!e.favorite,t.favorite_text=e.favorite_text,t.favorite&&!t.favorite_text&&(t.favorite_text=e.text),this.context.check_favorite(t),(t.tag!==e.tag||e.new_tag)&&this.context.move_item(t,e.new_tag||e.tag);for(var a in e)Object.prototype.hasOwnProperty.call(t,a)&&"new_tag"!==a&&"tag"!==a&&(t[a]=e[a]);return{category:this.context.category_name,tag:t.tag}},Dynalinks.prototype.export_category=function(t){this.save_data_to_file(t+".txt",this.database[t],"my_cat")},Dynalinks.prototype.export_tag=function(t,e){var a=this.get_category_context(t).pages[e];this.save_data_to_file(e+".txt",a,"my_page")},Dynalinks.prototype.remove_category=function(t){this.database[t]&&delete this.database[t],this.categories[t]&&delete this.categories[t],this.names[t]&&delete this.names[t],remove_by_field_value(this.category_list,"href",t)},Dynalinks.prototype.search=function(t,e){e=e.toUpperCase();for(var a,i=new Array,n=0;n<this.category_list.length;n++)a=this.category_list[n].href,this.database[a].forEach(function(n){t.every(function(t){return-1===n[t].toUpperCase().search(e)||(i.push({item:n,category:a}),!1)})});return i},Vue.component("mt-input-element",{props:["params"],render:function(t){function e(t){i.params.value=t.target.value}var a={},i=this,n={};if(n.attrs={},this.params)if("text"===this.params.element_type)a.type="text",a.placeholder=this.params.placeholder;else if("select"===this.params.element_type){var o=[];if(this.params.options)for(var r=0;r<this.params.options.length;r++){var s={},c=this.params.options[r];c.value===this.params.value&&(s.selected="1"),s.value=c.value,o[r]=t("option",{attrs:s},c.text)}return n.on={input:e},t("select",n,o)}return t("input",{attrs:a,on:{change:e}})}}),Vue.component("mt-edit-form",{template:'<div class="mt-form edit-form-container">\r    <h3 class="edit-form-title"> {{title}}</h3>\r    <div class="mt-input-container"><mt-input-element v-bind:params="params"> </mt-input-element></div>\r    <button class="edit-form-ok-btn" v-on:click="ok">ОК</button>\r    <button class="edit-form-cancel-btn" v-on:click="cancel">Отмена</button>\r</div>',data:function(){var t={};return t.title="test",t.params={element_type:"select",value:"BBB"},t.params.options=[{value:"AAA",text:"aaa"},{value:"BBB",text:"bbb"}],t},methods:{ok:function(t){console.log(this.params)},cancel:function(t){console.log("cancel")}}});var Form_Fabric={};Form_Fabric.escape_text=function(t){return this.not_escape?t:t.replace(/'|"/g,"&quot;").replace(/</g,"$lt;").replace(/>/g,"$gt;")},Form_Fabric.select=function(t,e){var a=!(void 0===e),i="";if(Array.isArray(t))for(var n=0,o=t.length;n<o;n++)i+='<option value="'+n+'"',a&&e==n&&(i+=" selected "),i+=">"+t[n]+"</option>";else for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(i+='<option value="'+n+'"',a&&e===n&&(i+=" selected "),i+=">"+t[n]+"</option>");var r=document.createElement("select");return r.innerHTML=i,r},Form_Fabric.text=function(t){var e=document.createElement("input");return e.type="text",t&&(e.value=Form_Fabric.escape_text(t||"")),e},Form_Fabric.label=function(t){var e=document.createElement("div");return e.className="popup-form-static-text",e.style["text-align"]="center",e.innerHTML="<h3>"+Form_Fabric.escape_text(t||" ")+"</h3>",e},Form_Fabric.textarea=function(t){var e=document.createElement("textarea");return t&&(e.value=Form_Fabric.escape_text(t||"")),e},Form_Fabric.create=function(t,e,a){var i=this[t];if(!i)throw t;return"select"===t?i(a,e):i(e)},Form_Fabric.create_fields=function(t){for(var e,a,i,n=document.createElement("div"),o=0;o<t.length;o++)e=t[o],a=this.create(e.type,e.value,e.dict),"data-value"in e&&a.setAttribute("data-value",e["data-value"]),(i=document.createElement("div")).className="dummy",i.appendChild(a),n.appendChild(i);return n},PopupForm.prototype.make_unique=function(){this.constructor.prototype.onshow&&this.constructor.prototype.onshow.cancel(),this.constructor.prototype.onshow=this},PopupForm.prototype.close_unique=function(){this.constructor.prototype.onshow=null},PopupForm.prototype.onshow=null,PopupForm.prototype.create_template=function(t){if(!this.template){this.template=document.createElement("div"),this.template.className="edit-form-container",this.template.style["background-color"]="#FFFFFF";var e=this.title?'<h3 class="edit-form-title">'+this.escape_text(this.title)+"</h3>":"";e+='<div class="mt-input-container"></div><button class="edit-form-ok-btn">ОК</button><button class="edit-form-cancel-btn">Отмена</button>',this.template.innerHTML=e,this.template.style.background_color="#FFFFFF",this.template.style.padding="5px",this.template.style["box-shadow"]="0 0 10px rgba(0,0,0,0.5)"}this.template.style.position="fixed"},PopupForm.prototype.escape_text=function(t){return t.replace(/'|"/g,"&quot;").replace(/</,"$lt;").replace(/>/,"$gt;")},PopupForm.prototype.init=function(){var t=this;t.template.onkeydown=function(e){switch(e.keyCode){case 27:t.cancel();break;case 13:t._ok()}}},PopupForm.prototype.attach_focus=function(){var t=this;t.template.on("blur",function(e){t.cancel()})},PopupForm.prototype.insert=function(){this.template.style.display="block",document.body.appendChild(this.template);var t=window.innerWidth/2-this.template.offsetWidth/2,e=window.innerHeight/2-this.template.offsetHeight/2;this.template.style.left=t+"px",this.template.style.top=e+"px"},PopupForm.prototype.detach=function(){this.template.parentNode.removeChild(this.template)},PopupForm.prototype.save_text=function(t){},PopupForm.prototype.show=function(t){this.initialize(),this.make_unique(),this.jquery_obj=t,this.change_text&&t&&this.save_text(t),this.insert(),this.result=-1,this.form.focus()},PopupForm.prototype.hide=function(){this.close_unique(),this.detach(),this.change_text&&this.jquery_obj},PopupForm.prototype.cancel=function(){this.hide()},PopupForm.prototype._get_values_from_inputs=function(t,e){if(e)for(var a,i=0;i<e.length;i++)e[i].hasAttribute("data-value")&&(a=e[i].getAttribute("data-value"),"checkbox"===e[i].type?t[a]=!!e[i].checked:"text"==e[i].type?this.not_escape?t[a]=e[i].value:t[a]=this.escape_text(e[i].value):t[a]=e[i].value)},PopupForm.prototype._get_value=function(){var t;return"custom"===this.type?(t={},this._get_values_from_inputs(t,this.form.querySelectorAll("input")),this._get_values_from_inputs(t,this.form.querySelectorAll("select")),this._get_values_from_inputs(t,this.form.querySelectorAll("textarea"))):"select"===this.type?t=this.form.options[this.form.selectedIndex].value:"text"===this.type?(t=this.form.value,this.not_escape||(t=this.escape_text(t))):"textarea"===this.type&&(t=this.form.value,this.not_escape||(t=this.escape_text(t))),t},PopupForm.prototype._ok=function(){value=this._get_value(),this.hide(),this.handler&&this.handler(value)&&(this.result=value,this.text=this.dict?this.dict[value]:value)},ModalForm.prototype=Object.create(PopupForm.prototype),ModalForm.prototype.constructor=ModalForm,ModalForm.prototype.onShow=null,ModalForm.prototype.create_template=function(t){if(!this.template){this.template=$('<form class="modal-edit-form-container">');var e="";t.title&&(e='<div class="mt-edit-title"><i><h3>'+t.title+"</h3></i></div>"),e+='<div class="modal-edit-form mt-input-container"></div><div><button class="inplace-edit-ok">ОК</button><button class="inplace-edit-cancel">Отмена</button></div>',this.template.html(e),this.template.css({"background-color":"#FFFFFF"}),this.template.css({padding:"5px"}),this.template.css({"box-shadow":"0 0 10px rgba(0,0,0,0.5)"})}this.template.css({position:"absolute"})},ModalForm.prototype.insert=function(){$(document.body).append(this.template),this.template.css({display:"block"}),this.template.css({position:"fixed",left:"50%",top:"50%"}),this.template.css({"margin-left":-this.template.outerWidth()/2+"px","margin-top":-this.template.outerHeight()/2+"px"})};var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(t){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var e=t.document,a=function(){return t.URL||t.webkitURL||t},i=e.createElementNS("http://www.w3.org/1999/xhtml","a"),n=!t.externalHost&&"download"in i,o=function(a){var i=e.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,t,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(i)},r=t.webkitRequestFileSystem,s=t.requestFileSystem||r||t.mozRequestFileSystem,c=function(e){(t.setImmediate||t.setTimeout)(function(){throw e},0)},l=0,p=function(e){var i=function(){"string"==typeof e?a().revokeObjectURL(e):e.remove()};t.chrome?i():setTimeout(i,10)},u=function(t,e,a){for(var i=(e=[].concat(e)).length;i--;){var n=t["on"+e[i]];if("function"==typeof n)try{n.call(t,a||t)}catch(t){c(t)}}},h=function(e,c){var h,_,d,f=this,v=e.type,m=!1,g=function(){u(f,"writestart progress write writeend".split(" "))},y=function(){!m&&h||(h=a().createObjectURL(e)),_?_.location.href=h:void 0==t.open(h,"_blank")&&"undefined"!=typeof safari&&(t.location.href=h),f.readyState=f.DONE,g(),p(h)},b=function(t){return function(){if(f.readyState!==f.DONE)return t.apply(this,arguments)}},k={create:!0,exclusive:!1};if(f.readyState=f.INIT,c||(c="download"),n)return h=a().createObjectURL(e),i.href=h,i.download=c,o(i),f.readyState=f.DONE,g(),void p(h);t.chrome&&v&&"application/octet-stream"!==v&&(d=e.slice||e.webkitSlice,e=d.call(e,0,e.size,"application/octet-stream"),m=!0),r&&"download"!==c&&(c+=".download"),("application/octet-stream"===v||r)&&(_=t),s?(l+=e.size,s(t.TEMPORARY,l,b(function(t){t.root.getDirectory("saved",k,b(function(t){var a=function(){t.getFile(c,k,b(function(t){t.createWriter(b(function(a){a.onwriteend=function(e){_.location.href=t.toURL(),f.readyState=f.DONE,u(f,"writeend",e),p(t)},a.onerror=function(){var t=a.error;t.code!==t.ABORT_ERR&&y()},"writestart progress write abort".split(" ").forEach(function(t){a["on"+t]=f["on"+t]}),a.write(e),f.abort=function(){a.abort(),f.readyState=f.DONE},f.readyState=f.WRITING}),y)}),y)};t.getFile(c,{create:!1},b(function(t){t.remove(),a()}),b(function(t){t.code===t.NOT_FOUND_ERR?a():y()}))}),y)}),y)):y()},_=h.prototype,d=function(t,e){return new h(t,e)};return _.abort=function(){var t=this;t.readyState=t.DONE,u(t,"abort")},_.readyState=_.INIT=0,_.WRITING=1,_.DONE=2,_.error=_.onwritestart=_.onprogress=_.onwrite=_.onabort=_.onerror=_.onwriteend=null,d}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),My_Router.prototype.decode_params=function(t){for(var e=0;e<t.length;e++)t[e]=decodeURIComponent(t[e])},My_Router.prototype.apply_route=function(t,e){t.length>1&&t.splice(0,1),this.decode_params(t),e.callback.apply(e.obj,t)},My_Router.prototype.test_hash=function(t){for(var e,a,i=0;i<this.routes.length;i++)if(e=this.routes[i],e.re.lastIndex=0,a=e.re.exec(t))return this.apply_route(a,e),!0;this.default_route&&this.default_route.callback.apply(this.default_route.obj,[t])},My_Router.prototype.add_default=function(t,e){this.default_route={callback:t,obj:e}},My_Router.prototype._add=function(t,e,a){return this.routes.push({re:t,callback:e,obj:a})},My_Router.prototype.add_route=function(t,e,a){for(var i,n,o=t.split("/"),r="^",s={},c=0,l=0;l<o.length;l++)(!(i=o[l])||l>0)&&(r+="/"),i&&(":"===i[0]?(n={index:c},s[i.slice(1)]=n,c++,r+="([^/]+?)"):r+=i);r+="$",this._add(new RegExp(r),e,a)},My_Router.prototype.hash_change=function(t){var e=window.location.hash;e&&((e=e.split("#")).length>1&&(e=e[1]),e&&"/"==e[0]&&(e=e.slice(1))),this.test_hash(e)},My_Router.prototype.refresh=function(){this.hash_change()},My_Router.prototype.navigate=function(t,e){if(e){var a="#"+t;window.location.hash==a?this.test_hash(t):window.location.hash=a}else this.test_hash(t)},My_Router.prototype.start=function(t){var e=this;window.addEventListener("hashchange",function(t){e.hash_change(t)},!1),t&&this.hash_change()},function(){if(void 0===t)var t={database:{},names:{}}}(),Vue_Application.prototype=Object.create(Application.prototype),Vue_Application.prototype.constructor=Vue_Application;var event_bus;Vue_Application.prototype.initialize=function(){event_bus=new Vue,"object"==typeof dynalinks_vue?(this.main_menu=dynalinks_vue.create_main_menu(this),this.vue=dynalinks_vue.create_vue_app(this)):(register_main_menu(this),this.vue=create_vue_app(dynalinks)),this.init_router();var t=this;event_bus.$on("delete-record",function(e){t.remove_item(e)})},Vue_Application.prototype.add_item=function(){var t=this.dynalinks.get_active_context();if(t){var e=t.category_name;mr.navigate("add/"+e,!0)}else console.log("Error add record! Category not found!",this.dynalinks.category_name)},Vue_Application.prototype.turn_edit_mode=function(){"grid-edit"===this.vue.main_page_view?this.vue.change_page_view("page-content-grid"):this.vue.change_page_view("grid-edit")},Vue_Application.prototype.show_category_page=function(t,e){if(t&&this.vue.categories[t])if(this.vue.current_category&&this.vue.current_category!==t&&(this.dynalinks.set_category(t),this.vue.show_category(t)),e)this.dynalinks.set_page(e),this.vue.show_page(e);else{var a=dynalinks.get_first_page_from_category(t);this.dynalinks.set_page(a),this.vue.show_page(a)}else console.log("Error! Category "+t+" not found!"),this.vue.show_error("Error! Category "+t+" not found!")},Vue_Application.prototype.show_search_result=function(t){var e=this.dynalinks.search(["text","href"],t);this.search_results=e,this.vue.show_search_result(e)},Vue_Application.prototype.add_record_to_category=function(t){if(this.dynalinks.categories[t]){var e=this,a={tag:this.vue.active_page_name,text:"",href:"",favorite:!1,favorite_text:""};this.vue.show_update_form(a,t,function(a){var i=clone_fields(a,["href","text","tag","favorite","favorite_text"]);e.dynalinks.add_link_to_category(i,t);var n=i.tag;mr.navigate(e.dynalinks.create_url(t,n),!0)},function(){mr.navigate(e.dynalinks.create_url(t),!0)})}else this.vue.show_error("Category "+t+" not found!")},Vue_Application.prototype.update_record=function(t,e){var a=this,i=a.dynalinks.categories[t];if(i){var n=i.hash[e];if(n){var o=n.tag,r=(n.favorite,create_clone_object(n));a.vue.show_update_form(r,t,function(e){a.dynalinks.update_item(n,r),mr.navigate(a.dynalinks.create_url(t,e.tag),!0)},function(){mr.navigate(a.dynalinks.create_url(t,o),!0)})}else console.log("Error update record!")}else console.log("Error update record!")},Vue_Application.prototype.init_router=function(){var t=this;(mr=new My_Router).add_route("view/:category",this.show_category_page,this),mr.add_route("view/:category/:page",this.show_category_page,this),mr.add_route("update/:category/:id",this.update_record,this),mr.add_route("add/:category",this.add_record_to_category,this),mr.add_default(function(e){name=t.vue.category_list[0].href,this.show_category_page(name)},this),mr.add_route("search/:value",function(e){t.show_search_result(decodeURIComponent(e))},this),mr.start(!0)};var app=new Vue_Application(find_database());String.prototype.trim||function(){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}();